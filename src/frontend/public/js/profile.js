(()=>{const v=a=>document.getElementById(a),tt=window.api,rt=window.show,J=(...a)=>{try{const o=typeof window!="undefined"?window.toast:null;if(typeof o=="function")return o(...a)}catch(o){}},nt=window.bindClick,ft=()=>window.token;function lt(a){const o=(a!=null?a:"").toString().trim();if(!o)return null;const r=Number.parseFloat(o);return Number.isFinite(r)?r:null}function wt(){var m,x;const a=document.getElementById("birthDate"),o=document.getElementById("birthHour"),r=document.getElementById("birthMinute"),g=((a==null?void 0:a.value)||"").trim();if(!g)return null;const S=(m=o==null?void 0:o.value)!=null?m:"",C=(x=r==null?void 0:r.value)!=null?x:"",D=S!==""&&C!=="",n=D?String(S).padStart(2,"0"):"00",l=D?String(C).padStart(2,"0"):"00";return`${g}T${n}:${l}:00`}function vt(a,o){var r;try{const D=(((r=new Intl.DateTimeFormat("en-US",{timeZone:o,hour:"2-digit",minute:"2-digit",timeZoneName:"shortOffset"}).formatToParts(a).find(x=>x.type==="timeZoneName"))==null?void 0:r.value)||"").match(/([+-])(\d{1,2})(?::?(\d{2}))?/);if(!D)return 0;const n=D[1]==="-"?-1:1,l=parseInt(D[2]||"0",10),m=parseInt(D[3]||"0",10);return n*(l*60+m)}catch(g){return 0}}function St(a,o){try{const r=new Date(String(o)),g=vt(r,a),S=g<0?"-":"+",C=Math.abs(g),D=String(Math.floor(C/60)).padStart(2,"0"),n=String(C%60).padStart(2,"0");return`UTC${S}${D}:${n}`}catch(r){return""}}function yt(){let a=null;try{a=window.liveTz||null}catch(o){}if(!a)try{a=localStorage.getItem("live_tz")}catch(o){}if(!a)try{a=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(o){}return a||"UTC"}function dt(){try{const a=document.getElementById("tzTopBadgeText");if(!a)return;const o=yt(),r=St(o,new Date().toISOString());a.textContent=`Using timezone: ${o}${r?` (${r})`:""}`}catch(a){}}async function ut(){var r,g,S,C,D;if(!ft())return;const a=document.getElementById("radixJson"),o=document.getElementById("radixPretty");if(a)try{a.textContent="(loading\u2026)",o&&(o.innerHTML="");const n=await tt("/api/profile/radix",{auth:!0});a.textContent=JSON.stringify(n,null,2);try{if(o){const l=n&&n.bodies?n.bodies:{},m=[["MOON","Moon","\u263D"],["SUN","Sun","\u2609"],["MERCURY","Mercury","\u263F"],["VENUS","Venus","\u2640"],["MARS","Mars","\u2642"],["JUPITER","Jupiter","\u2643"],["SATURN","Saturn","\u2644"],["URANUS","Uranus","\u2645"],["NEPTUNE","Neptune","\u2646"],["PLUTO","Pluto","\u2647"]],x=["\u2648\uFE0E","\u2649\uFE0E","\u264A\uFE0E","\u264B\uFE0E","\u264C\uFE0E","\u264D\uFE0E","\u264E\uFE0E","\u264F\uFE0E","\u2650\uFE0E","\u2651\uFE0E","\u2652\uFE0E","\u2653\uFE0E"],H=s=>{if(typeof s!="number"||Number.isNaN(s))return"";const b=(s%360+360)%360,h=Math.floor(b/30),w=b-h*30,z=Math.floor(w),I=Math.round((w-z)*60),A=String(z).padStart(2,"0"),t=String(I).padStart(2,"0");return`${A}\xB0${x[h]}${t}\u2032`};let F=null,K=null;try{const s=n&&n.houses?n.houses:null;if(s&&Array.isArray(s.cusps)&&s.cusps.length>=1){const b=Array.isArray(s.cusps)?s.cusps:[],h=Array.from({length:12}).map((z,I)=>{const A=b[I];return typeof A=="number"?(A%360+360)%360:NaN});K=h;const w=z=>{for(let I=1;I<=12;I++){const A=(z+I)%12;if(!Number.isNaN(h[A]))return A}return-1};F=z=>{const I=(z%360+360)%360;for(let A=0;A<12;A++){const t=h[A];if(Number.isNaN(t))continue;const u=w(A);if(u===-1||u===A)continue;const f=h[u];if(!Number.isNaN(f)){if(t<=f){if(I>=t&&I<f)return A}else if(I>=t||I<f)return A}}return-1}}}catch(s){}const Y=`
            <table class="list planets-table">
              <colgroup>
                <col class="icon" />
                <col />
                <col class="pos" />
                <col class="house" />
              </colgroup>
              <thead>
                <tr>
                  <th>Pl</th>
                  <th>Planet</th>
                  <th>Position</th>
                  <th>House</th>
                </tr>
              </thead>
              <tbody>${m.filter(([s])=>l[s]).map(([s,b,h])=>{const w=l[s].lon,z=F&&typeof w=="number"?F(w):-1,I=z>=0?String(z+1):"";return`<tr><td class="mono">${h}</td><td>${b}</td><td class="mono">${H(w)}</td><td class="mono">${I}</td></tr>`}).join("")}</tbody>
            </table>`,W=[{deg:0,label:"0\xB0",sym:"\u260C",orb:5},{deg:60,label:"60\xB0",sym:"\u2736",orb:4},{deg:90,label:"90\xB0",sym:"\u25A1",orb:4},{deg:120,label:"120\xB0",sym:"\u25B3",orb:4},{deg:180,label:"180\xB0",sym:"\u260D",orb:5}],et=m.filter(([s])=>l[s]).map(([s])=>s),ct=(s,b)=>{let h=Math.abs(s-b)%360;return h>180&&(h=360-h),h},ot=(s,b)=>{const h=ct(s,b);for(const w of W)if(Math.abs(h-w.deg)<=w.orb)return w;return null};let e='<table class="list planets-table">';const i='<colgroup><col class="icon"><col class="planet"><col class="sign"><col class="deg"><col class="house"><col class="cusp">'+new Array(W.length).fill('<col class="aspect">').join("")+"</colgroup>";e+=i;const d=["<th></th>","<th>Planet</th>","<th>Sign</th>","<th>Deg</th>","<th>House</th>","<th>Cusp\xB0</th>"].concat(W.map(s=>`<th scope="col">${s.sym} ${s.label}</th>`)).join("");e+=`<thead><tr>${d}</tr></thead><tbody>`;for(let s=0;s<et.length;s++){const b=et[s],h=((r=m.find(([c])=>c===b))==null?void 0:r[2])||b,w=((g=m.find(([c,E])=>c===b))==null?void 0:g[1])||b,z=(S=l[b])==null?void 0:S.lon,I=typeof z=="number"&&typeof F=="function"?F(z):-1,A=I>=0?String(I+1):"",t=(z%360+360)%360,u=Math.floor(t/30),f=t-u*30,M=Math.floor(f),O=Math.round((f-M)*60),Q=String(M).padStart(2,"0"),R=String(O).padStart(2,"0"),j=x[u]||"";let T="";if(I>=0&&Array.isArray(K)){const c=K[I];if(typeof c=="number"&&!Number.isNaN(c)){const E=(c%360+360)%360,k=E-Math.floor(E/30)*30,L=Math.floor(k),B=Math.round((k-L)*60),N=String(L).padStart(2,"0"),Z=String(B).padStart(2,"0");T=`${N}\xB0${Z}\u2032`}}let y=`<tr><td class="mono">${h}</td><td>${w}</td><td class="mono">${j}</td><td class="mono">${Q}\xB0${R}\u2032</td><td class="mono">${A}</td><td class="mono">${T}</td>`;for(const c of W){const E=[];for(let k=0;k<et.length;k++){if(k===s)continue;const L=et[k],B=ot(l[b].lon,l[L].lon);if(B&&B.deg===c.deg){const N=((C=m.find(([Z])=>Z===L))==null?void 0:C[2])||L;E.push(N)}}y+=`<td>${E.join(" ")}</td>`}y+="</tr>",e+=y}try{const s=n&&n.houses?n.houses:null;if(s){const b=(h,w)=>{var j;if(typeof w!="number")return"";const z=(w%360+360)%360,I=Math.floor(z/30),A=z-I*30,t=Math.floor(A),u=Math.round((A-t)*60),f=String(t).padStart(2,"0"),M=String(u).padStart(2,"0"),O=x[I]||"";let R=`<tr><td class="mono">${h}</td><td>${h}</td><td class="mono">${O}</td><td class="mono">${f}\xB0${M}\u2032</td><td class="mono"></td><td class="mono"></td>`;for(const T of W){const y=[];for(let c=0;c<et.length;c++){const E=et[c],k=l[E];if(!k||typeof k.lon!="number")continue;const L=ot(z,k.lon);if(L&&L.deg===T.deg){const B=((j=m.find(([N])=>N===E))==null?void 0:j[2])||E;y.push(B)}}R+=`<td>${y.join(" ")}</td>`}return R+="</tr>",R};e+=b("ASC",s.asc),e+=b("MC",s.mc)}}catch(s){}e+="</tbody></table>";let _="";const p=n&&n.houses?n.houses:null;if(p&&Array.isArray(p.cusps)&&p.cusps.length>=1){const s=typeof p.asc=="number"?H(p.asc):"",b=typeof p.mc=="number"?H(p.mc):"",h=p.system?String(p.system):"Houses",w=Array.isArray(p.cusps)?p.cusps:[],z=Array.from({length:12}).map((T,y)=>{const c=w[y];return typeof c=="number"?(c%360+360)%360:NaN}),I=T=>{for(let y=1;y<=12;y++){const c=(T+y)%12;if(!Number.isNaN(z[c]))return c}return-1},A=T=>{const y=(T%360+360)%360;for(let c=0;c<12;c++){const E=z[c];if(Number.isNaN(E))continue;const k=I(c);if(k===-1||k===c)continue;const L=z[k];if(!Number.isNaN(L)){if(E<=L){if(y>=E&&y<L)return c}else if(y>=E||y<L)return c}}return-1},t=T=>{var y;return((y=m.find(([c])=>c===T))==null?void 0:y[2])||T},u=Object.keys(n.bodies||{}),f=["MOON","SUN","MERCURY","VENUS","MARS","JUPITER","SATURN","URANUS","NEPTUNE","PLUTO"],M=u.filter(T=>f.includes(T)),O=Array.from({length:12},()=>[]);for(const T of M){const y=(D=n.bodies[T])==null?void 0:D.lon;if(typeof y!="number")continue;const c=A(y);c>=0&&O[c].push(t(T))}const Q=Array.from({length:12}).map((T,y)=>{const c=y+1,E=p.cusps[y],k=typeof E=="number"?H(E):"",L=O[y].join(" ");return`<tr>
                <td class="mono">${c}</td>
                <td class="mono">${k}</td>
                <td class="mono">${L}</td>
              </tr>`}).join(""),R=`
              <div class="row" style="margin:8px 0; gap:8px; align-items:center;">
                <span class="badge">${h}</span>
                ${s?`<span class="badge mono">ASC ${s}</span>`:""}
                ${b?`<span class="badge mono">MC ${b}</span>`:""}
              </div>`,j=`
              <table class="list houses-table">
                <colgroup>
                  <col class="num" />
                  <col class="cusp" />
                  <col class="planets" />
                </colgroup>
                <thead>
                  <tr>
                    <th>House</th>
                    <th>Cusp</th>
                    <th>Planets</th>
                  </tr>
                </thead>
                <tbody>${Q}</tbody>
              </table>`;_=""}const U="",$=`<div class="radix-panel">${e}</div>`;o.innerHTML=`<div class="radix-layout">${$}</div>`}}catch(l){}}catch(n){console.error("profile.radix:ERROR",n),a.textContent="No radix available yet. Set your birth data and save your profile to compute it.",o&&(o.innerHTML="")}}function mt(a){const o=document.getElementById("livePlaceList");if(o){if(!a||!a.length){o.style.display="none",o.innerHTML="";return}o.innerHTML=a.map((r,g)=>{const S=r.display_name.split(",")[0]||r.display_name,C=r.display_name.replace(S+", ","");return`<div class="autocomplete-item" data-idx="${g}">
        <div class="title">${S}</div>
        <div class="sub">${C}</div>
      </div>`}).join(""),o.style.display="block"}}function Et(){const a=document.getElementById("livePlace"),o=document.getElementById("livePlaceList");if(!a||!o)return;let r=[],g=-1;const S=gt(async()=>{const n=a.value.trim();if(n.length<2){mt([]);return}try{const l=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=8&q=${encodeURIComponent(n)}`,x=await(await fetch(l,{headers:{Accept:"application/json"}})).json();r=Array.isArray(x)?x:[],g=-1,mt(r)}catch(l){mt([])}},250);a.addEventListener("input",S),a.addEventListener("focus",()=>{a.value.trim().length>=2&&S()}),a.addEventListener("keydown",n=>{o.style.display==="block"&&(n.key==="ArrowDown"?(n.preventDefault(),g=Math.min(g+1,r.length-1),C()):n.key==="ArrowUp"?(n.preventDefault(),g=Math.max(g-1,0),C()):n.key==="Enter"?g>=0&&(n.preventDefault(),D(r[g])):n.key==="Escape"&&(o.style.display="none"))});function C(){o.querySelectorAll(".autocomplete-item").forEach((l,m)=>{l.style.background=m===g?"var(--hl, rgba(124,58,237,0.12))":""})}async function D(n){try{a.value=n.display_name||a.value}catch(F){}const l=document.getElementById("liveLat"),m=document.getElementById("liveLon"),x=document.getElementById("liveTz"),H=document.getElementById("liveTzLabel");l&&(l.value=String(n.lat||"")),m&&(m.value=String(n.lon||"")),o.style.display="none";try{const F=parseFloat((l==null?void 0:l.value)||""),K=parseFloat((m==null?void 0:m.value)||"");if(!Number.isNaN(F)&&!Number.isNaN(K)){const G=await tt("/api/timezone",{method:"POST",body:{lat:F,lon:K}}),Y=G&&(G.time_zone||G.timezone||G.tz);if(Y){x&&(x.value=Y),H&&(H.textContent=Y);try{window.liveTz=Y}catch(W){}try{localStorage.setItem("live_tz",Y)}catch(W){}}}}catch(F){try{H&&(H.textContent="(auto failed)")}catch(K){}}}o.addEventListener("click",n=>{const l=n.target.closest(".autocomplete-item");if(!l)return;const m=parseInt(l.getAttribute("data-idx")||"-1",10);m>=0&&r[m]&&D(r[m])}),document.addEventListener("click",n=>{!o.contains(n.target)&&n.target!==a&&(o.style.display="none")})}function gt(a,o){let r;return(...g)=>{clearTimeout(r),r=setTimeout(()=>a(...g),o)}}function ht(a){const o=document.getElementById("birthPlaceList");if(o){if(!a||!a.length){o.style.display="none",o.innerHTML="";return}o.innerHTML=a.map((r,g)=>{const S=r.display_name.split(",")[0]||r.display_name,C=r.display_name.replace(S+", ","");return`<div class="autocomplete-item" data-idx="${g}">
        <div class="title">${S}</div>
        <div class="sub">${C}</div>
      </div>`}).join(""),o.style.display="block"}}function Lt(){const a=document.getElementById("birthPlace"),o=document.getElementById("birthPlaceList");if(!a||!o)return;let r=[],g=-1;const S=gt(async()=>{const n=a.value.trim();if(n.length<2){ht([]);return}try{const l=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=8&q=${encodeURIComponent(n)}`,x=await(await fetch(l,{headers:{Accept:"application/json"}})).json();r=Array.isArray(x)?x:[],g=-1,ht(r)}catch(l){ht([])}},250);a.addEventListener("input",S),a.addEventListener("focus",()=>{a.value.trim().length>=2&&S()}),a.addEventListener("keydown",n=>{o.style.display==="block"&&(n.key==="ArrowDown"?(n.preventDefault(),g=Math.min(g+1,r.length-1),C()):n.key==="ArrowUp"?(n.preventDefault(),g=Math.max(g-1,0),C()):n.key==="Enter"?g>=0&&(n.preventDefault(),D(r[g])):n.key==="Escape"&&(o.style.display="none"))});function C(){o.querySelectorAll(".autocomplete-item").forEach((l,m)=>{l.style.background=m===g?"var(--hl, rgba(124,58,237,0.12))":""})}async function D(n){try{a.value=n.display_name||a.value}catch(F){}const l=document.getElementById("birthLat"),m=document.getElementById("birthLon"),x=document.getElementById("birthTz"),H=document.getElementById("birthTzLabel");l&&(l.value=String(n.lat||"")),m&&(m.value=String(n.lon||"")),o.style.display="none";try{const F=parseFloat((l==null?void 0:l.value)||""),K=parseFloat((m==null?void 0:m.value)||"");if(!Number.isNaN(F)&&!Number.isNaN(K)){const G=await tt("/api/timezone",{method:"POST",body:{lat:F,lon:K}}),Y=G&&(G.time_zone||G.timezone||G.tz);if(Y){x&&(x.value=Y),H&&(H.textContent=Y);try{window.liveTz=Y}catch(W){}try{localStorage.setItem("live_tz",Y)}catch(W){}}}}catch(F){try{H&&(H.textContent="(auto failed)")}catch(K){}}}o.addEventListener("click",n=>{const l=n.target.closest(".autocomplete-item");if(!l)return;const m=parseInt(l.getAttribute("data-idx")||"-1",10);m>=0&&r[m]&&D(r[m])}),document.addEventListener("click",n=>{!o.contains(n.target)&&n.target!==a&&(o.style.display="none")})}function _t(){document.querySelectorAll('input[type="time"]').forEach(o=>{o.step=60,o.setAttribute("pattern","[0-9]{2}:[0-9]{2}"),o.addEventListener("input",function(){const r=this.value;r&&r.includes(" ")&&(this.value=r.split(" ")[0])})})}document.addEventListener("DOMContentLoaded",async()=>{var W,et,ct,ot;const a=document.getElementById("notifyBrowser"),o=document.getElementById("notifyEmail"),r=document.getElementById("notifyEmailDisabled");let g=!!(window.profileMeta&&window.profileMeta.email_verified),S=null;const C=()=>{o&&r&&(o.disabled=!g,r.style.display=g?"none":"")},D=e=>{e&&(a&&typeof e.notify_browser_meetups=="boolean"&&(a.checked=e.notify_browser_meetups),o&&typeof e.notify_email_meetups=="boolean"&&(o.checked=e.notify_email_meetups),C())};C(),a&&a.addEventListener("change",async()=>{var e;try{a.checked&&"Notification"in window&&(await((e=window.ensureNotificationPermission)==null?void 0:e.call(window))||(a.checked=!1))}catch(i){console.error("notifyBrowser change failed",i),a.checked=!1}});try{const e=await tt("/api/profile/me",{auth:!0});e&&typeof e.email_verified!="undefined"&&(window.profileMeta={email_verified:!!e.email_verified},g=!!e.email_verified,C())}catch(e){console.error("profile.loadMe failed",e)}try{S=await tt("/api/profile",{auth:!0}),D(S)}catch(e){console.error("profile.loadProfile failed",e)}try{dt()}catch(e){}try{window.addEventListener("storage",e=>{e&&e.key==="live_tz"&&dt()})}catch(e){}_t(),Lt(),Et();let n=new Set(["en"]),l=()=>{};try{window.SimpleI18n&&await window.SimpleI18n.init();const e=document.getElementById("primaryLanguage"),i=document.getElementById("languageTagInput"),d=document.getElementById("languageInput"),_=document.getElementById("selectedTags"),p=document.getElementById("languageAutocomplete");if(e&&i&&d&&_&&p){const U=((W=window.SimpleI18n)==null?void 0:W.languages)||{};try{window.selectedLanguages=n}catch(t){}let $=-1;try{const t=Object.entries(U).sort((f,M)=>f[1].localeCompare(M[1],void 0,{sensitivity:"base"}));e.innerHTML=t.map(([f,M])=>`<option value="${f}">${M}</option>`).join("");const u=window.SimpleI18n&&window.SimpleI18n.currentLang||"en";e.value=u}catch(t){}const s=(t,u)=>{let f;return(...M)=>{clearTimeout(f),f=setTimeout(()=>t(...M),u)}};l=()=>{_.innerHTML=Array.from(n).map(t=>{const u=U[t]||t;return`<span class="language-tag" data-lang="${t}" title="Click to make primary">${u} <button type="button" class="tag-remove" data-lang="${t}" aria-label="Remove">\xD7</button></span>`}).join("")};const b=t=>{const u=Object.entries(U).filter(([f,M])=>{if(n.has(f)||e&&f===e.value)return!1;const O=t.toLowerCase();return M.toLowerCase().includes(O)||f.toLowerCase().includes(O)}).slice(0,8);if(u.length===0||t.trim()===""){p.style.display="none";return}p.innerHTML=u.map(([f,M],O)=>`<div class="language-autocomplete-item" data-lang="${f}" data-index="${O}">${M}</div>`).join(""),p.style.display="block",$=-1},h=t=>{if(!(e&&t===e.value)&&U[t]&&!n.has(t)){n.add(t);try{window.selectedLanguages=n}catch(u){}l(),d.value="",p.style.display="none",n.size===1&&window.SimpleI18n&&window.SimpleI18n.changeLanguage(t)}},w=t=>{n.delete(t);try{window.selectedLanguages=n}catch(u){}l()},z=t=>{const u=p.querySelectorAll(".language-autocomplete-item");if(t.key==="ArrowDown")t.preventDefault(),$=Math.min($+1,u.length-1),I(u);else if(t.key==="ArrowUp")t.preventDefault(),$=Math.max($-1,-1),I(u);else if(t.key==="Enter"){if(t.preventDefault(),$>=0&&u[$]){const f=u[$].dataset.lang;h(f)}}else t.key==="Escape"&&(p.style.display="none",$=-1)},I=t=>{t.forEach((u,f)=>{u.classList.toggle("highlighted",f===$)})},A=s(t=>b(t),200);d.addEventListener("input",t=>{A(t.target.value)}),d.addEventListener("keydown",z),d.addEventListener("focus",()=>{d.value.trim()&&b(d.value)}),e.addEventListener("change",async()=>{var u;const t=e.value;try{await((u=window.SimpleI18n)==null?void 0:u.changeLanguage(t))}catch(f){}if(n.has(t)){n.delete(t);try{window.selectedLanguages=n}catch(f){}l()}d.value.trim()&&b(d.value)}),p.addEventListener("click",t=>{const u=t.target.closest(".language-autocomplete-item");u&&h(u.dataset.lang)}),_.addEventListener("click",t=>{var M;const u=t.target.closest(".tag-remove");if(u){w(u.dataset.lang);return}const f=t.target.closest(".language-tag");if(f){const O=f.getAttribute("data-lang");if(e&&O&&U[O]){if(e.value=O,n.has(O)){n.delete(O);try{window.selectedLanguages=n}catch(Q){}l()}try{(M=window.SimpleI18n)==null||M.changeLanguage(O)}catch(Q){}}}}),document.addEventListener("click",t=>{i.contains(t.target)||(p.style.display="none",$=-1)});try{const t=S||await tt("/api/profile",{auth:!0});S||(S=t),D(t);const u=R=>!!U[R],f=t&&t.lang_primary,M=f&&u(f)?f:e.value;e.value=M;try{await((et=window.SimpleI18n)==null?void 0:et.changeLanguage(e.value))}catch(R){}const Q=(Array.isArray(t==null?void 0:t.languages)?t.languages:[]).filter(R=>R&&u(R)&&R!==e.value);n=new Set(Q.length?Q:Array.from(n));try{window.selectedLanguages=n}catch(R){}try{t!=null&&t.display_name&&v("displayName")&&(v("displayName").value=t.display_name);const R=!!(t!=null&&t.birth_time_known),j=t!=null&&t.birth_dt_local?String(t.birth_dt_local):null,T=t!=null&&t.birth_dt_utc?String(t.birth_dt_utc):null;let y=t!=null&&t.birth_tz?String(t.birth_tz):null;try{const L=((ct=v("birthPlace"))==null?void 0:ct.value)||t.birth_place_name||"",B=typeof(t==null?void 0:t.birth_lat)=="number"?t.birth_lat:NaN,N=typeof(t==null?void 0:t.birth_lon)=="number"?t.birth_lon:NaN,Z=!Number.isNaN(B)&&!Number.isNaN(N)&&B>=48.1&&B<=48.35&&N>=16.2&&N<=16.6;(/\b(Vienna|Wien)\b/i.test(L)||Z)&&(!y||y==="Europe/Paris")&&(y="Europe/Vienna")}catch(L){}const c=v("birthDate"),E=v("birthHour"),k=v("birthMinute");if(j)try{const L=j.slice(0,10),B=j.slice(11,13),N=j.slice(14,16);c&&L&&(c.value=L),E&&(E.value=R?B:""),k&&(k.value=R?N:"");try{const Z=document.getElementById("birthLocalLabel"),X=y||(t!=null&&t.birth_tz?String(t.birth_tz):"");Z&&(Z.textContent=`${L} ${B}:${N}${X?` (${X})`:""}`)}catch(Z){}}catch(L){}else if(T&&y)try{const L=/Z$/i.test(T)?T:T+"Z",B=new Date(L),N=new Intl.DateTimeFormat("en-CA",{timeZone:y,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}),Z=Object.fromEntries(N.formatToParts(B).map(P=>[P.type,P.value])),X=`${Z.year}-${Z.month}-${Z.day}`,at=Z.hour||"",q=Z.minute||"";c&&X&&(c.value=X),E&&(E.value=R?at:""),k&&(k.value=R?q:"");try{const P=document.getElementById("birthLocalLabel");P&&(P.textContent=`${X} ${at}:${q} (${y})`)}catch(P){}}catch(L){}if(t!=null&&t.birth_place_name&&v("birthPlace")&&(v("birthPlace").value=String(t.birth_place_name)),typeof(t==null?void 0:t.birth_lat)=="number"&&v("birthLat")&&(v("birthLat").value=String(t.birth_lat)),typeof(t==null?void 0:t.birth_lon)=="number"&&v("birthLon")&&(v("birthLon").value=String(t.birth_lon)),t!=null&&t.birth_tz){const L=v("birthTz"),B=document.getElementById("birthTzLabel");let N=String(t.birth_tz);try{const Z=((ot=v("birthPlace"))==null?void 0:ot.value)||t.birth_place_name||"",X=typeof(t==null?void 0:t.birth_lat)=="number"?t.birth_lat:NaN,at=typeof(t==null?void 0:t.birth_lon)=="number"?t.birth_lon:NaN,q=!Number.isNaN(X)&&!Number.isNaN(at)&&X>=48.1&&X<=48.35&&at>=16.2&&at<=16.6;(/\b(Vienna|Wien)\b/i.test(Z)||q)&&(!N||N==="Europe/Paris")&&(N="Europe/Vienna")}catch(Z){}L&&(L.value=N),B&&(B.textContent=N)}}catch(R){}l()}catch(t){}l()}}catch(e){console.error("Language tag input init failed:",e)}try{const e=document.getElementById("liveTz"),i=document.getElementById("liveTzLabel");e&&e.addEventListener("change",()=>{const d=e.value||"";if(d){try{window.liveTz=d}catch(_){}try{localStorage.setItem("live_tz",d)}catch(_){}i&&(i.textContent=d);try{dt()}catch(_){}try{window.setNavbarTzBadge&&window.setNavbarTzBadge()}catch(_){}}})}catch(e){}setTimeout(ut,300),nt("btn-radix-refresh",async()=>{try{await ut(),J("Radix refreshed")}catch(e){}}),nt("btn-account-delete",async()=>{var d,_,p,U;if(!ft()){J("Please login again before deleting your account","error");return}const e=(d=window.SimpleI18n)!=null&&d.t?window.SimpleI18n.t("profile.delete_account_confirm","Are you sure? This cannot be undone."):"Are you sure? This cannot be undone.";if(!window.confirm(e))return;const i=document.getElementById("btn-account-delete");i&&(i.disabled=!0);try{await tt("/api/profile",{method:"DELETE",auth:!0});const $=(_=window.SimpleI18n)!=null&&_.t?window.SimpleI18n.t("profile.account_deleted","Your account has been deleted."):"Your account has been deleted.";J($,"success");try{(p=window.setToken)==null||p.call(window,null)}catch(s){}try{(U=window.setRefreshToken)==null||U.call(window,null)}catch(s){}setTimeout(()=>{window.location.href="/index.html"},400)}catch($){console.error("Account deletion failed",$),J("Failed to delete account","error")}finally{i&&(i.disabled=!1)}});const m=document.getElementById("aiMessages"),x=document.getElementById("aiUserMsg");let H=[];function F(){if(!m)return;const e=H.map(i=>`<li class="item-card"><div class="item-sub">${i.content.replace(/</g,"&lt;")}</div></li>`).join("");m.innerHTML=e?`<ul class="list">${e}</ul>`:"";try{const i=document.getElementById("aiFollowRow");i&&H.length>0&&(i.style.removeProperty("display"),i.style.display="flex")}catch(i){}}async function K(e){var U;let i=null;try{i=((U=document.getElementById("primaryLanguage"))==null?void 0:U.value)||null}catch($){}i||(i=window.SimpleI18n&&window.SimpleI18n.currentLang||null);const d={message:e||null,history:H};i&&(d.lang=i);const _=await tt("/api/profile/interpret",{method:"POST",body:d,auth:!0}),p=_&&_.reply?String(_.reply):"";p&&(H.push({role:"assistant",content:p}),F())}nt("btn-interpret-initial",async()=>{var e;try{H=[],F(),await K(null);try{const i=document.getElementById("aiFollowRow");if(i){i.style.removeProperty("display"),i.style.display="flex";try{i.scrollIntoView({behavior:"smooth",block:"nearest"})}catch(d){}}}catch(i){}}catch(i){rt("profile.interpret:ERROR",i);const d=((e=window.SimpleI18n)==null?void 0:e.t("ai.error_initial"))||"Failed to get interpretation";J(d,"error")}}),nt("btn-interpret-send",async()=>{var i;if(!x)return;const e=(x.value||"").trim();if(e){H.push({role:"user",content:e}),x.value="",F();try{await K(e)}catch(d){rt("profile.interpret.send:ERROR",d);const _=((i=window.SimpleI18n)==null?void 0:i.t("ai.error_followup"))||"Failed to send message";J(_,"error")}}});async function G(e,i){const d=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(e)}&lon=${encodeURIComponent(i)}&zoom=10`,_=await fetch(d,{headers:{Accept:"application/json"}});if(!_.ok)throw new Error("Reverse geocoding failed");return _.json()}async function Y(){if(navigator.geolocation)try{const e=await new Promise((i,d)=>{navigator.geolocation.getCurrentPosition(i,d,{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})});return{lat:e.coords.latitude,lon:e.coords.longitude}}catch(e){}try{const i=await(await fetch("https://ipwho.is/?fields=latitude,longitude,success",{headers:{Accept:"application/json"}})).json();if(i&&i.success&&typeof i.latitude=="number"&&typeof i.longitude=="number")return{lat:i.latitude,lon:i.longitude}}catch(e){}throw new Error("Unable to determine location")}nt("btn-live-geolocate",async()=>{try{const{lat:e,lon:i}=await Y(),d=await G(e,i),_=d&&(d.display_name||d.address&&d.address.city||""),p=document.getElementById("livePlace"),U=document.getElementById("liveLat"),$=document.getElementById("liveLon"),s=document.getElementById("liveTz"),b=document.getElementById("liveTzLabel");p&&_&&(p.value=_),U&&(U.value=String(e)),$&&($.value=String(i));try{const h=await tt("/api/timezone",{method:"POST",body:{lat:e,lon:i}}),w=h&&(h.time_zone||h.timezone||h.tz);if(w){s&&(s.value=w),b&&(b.textContent=w);try{window.liveTz=w}catch(z){}try{localStorage.setItem("live_tz",w)}catch(z){}}}catch(h){}J("Current location detected")}catch(e){J("Could not detect current location","error")}}),nt("btn-birth-geolocate",async()=>{try{const{lat:e,lon:i}=await Y(),d=await G(e,i),_=d&&(d.display_name||d.address&&d.address.city||""),p=document.getElementById("birthPlace"),U=document.getElementById("birthLat"),$=document.getElementById("birthLon"),s=document.getElementById("birthTz"),b=document.getElementById("birthTzLabel");p&&_&&(p.value=_),U&&(U.value=String(e)),$&&($.value=String(i));try{const h=await tt("/api/timezone",{method:"POST",body:{lat:e,lon:i}}),w=h&&(h.time_zone||h.timezone||h.tz);w&&(s&&(s.value=w),b&&(b.textContent=w))}catch(h){}J("Birth location prefilled from current location")}catch(e){J("Could not fetch device location","error")}}),nt("btn-profile-update",async()=>{var e,i,d,_,p,U,$,s,b,h,w,z,I,A,t,u,f,M,O,Q,R;try{const j=((e=v("displayName"))==null?void 0:e.value)||null,T=(d=(i=v("liveTz"))==null?void 0:i.value)!=null&&d.trim?v("liveTz").value.trim():(_=v("liveTz"))==null?void 0:_.value,y=(p=document.getElementById("liveTzLabel"))==null?void 0:p.textContent,c=document.getElementById("primaryLanguage");let E=c&&c.value||null;(!E||!(((U=window.SimpleI18n)==null?void 0:U.languages)||{})[E])&&(E=($=window.SimpleI18n)!=null&&$.currentLang&&window.SimpleI18n.languages[window.SimpleI18n.currentLang]?window.SimpleI18n.currentLang:"en");let k=Array.from(window.selectedLanguages instanceof Set?window.selectedLanguages:new Set);const L=V=>{var it;return!!(((it=window.SimpleI18n)==null?void 0:it.languages)||{})[V]};let B=k.filter(V=>L(V));E&&(B=B.filter(V=>V!==E));const N=v("birthDate");if(!((N==null?void 0:N.value)||null)){try{(s=N==null?void 0:N.reportValidity)==null||s.call(N)}catch(V){}J("Birth date is required","error");return}const X=((b=v("birthHour"))==null?void 0:b.value)||"",at=((h=v("birthMinute"))==null?void 0:h.value)||"",q={display_name:j,birth_dt:wt(),birth_time_known:((w=v("birthHour"))==null?void 0:w.value)!==""&&((z=v("birthMinute"))==null?void 0:z.value)!=="",birth_place_name:((I=v("birthPlace"))==null?void 0:I.value)||null,birth_lat:lt((A=v("birthLat"))==null?void 0:A.value),birth_lon:lt((t=v("birthLon"))==null?void 0:t.value),birth_tz:((u=v("birthTz"))==null?void 0:u.value)||null,live_place_name:((f=v("livePlace"))==null?void 0:f.value)||null,live_lat:lt((M=v("liveLat"))==null?void 0:M.value),live_lon:lt((O=v("liveLon"))==null?void 0:O.value),live_tz:yt(),lang_primary:E,lang_secondary:null,languages:B,house_system:((Q=v("houseSystem"))==null?void 0:Q.value)||null};T?q.live_tz=T:y&&y!=="(auto or select)"&&(q.live_tz=y),E&&(q.lang_primary=E),B&&B.length&&(q.languages=B,q.lang_secondary=B[0]),console.log("profile.update:BODY",q),q.notify_browser_meetups=a?!!a.checked:void 0,q.notify_email_meetups=o?!!o.checked:void 0,S&&(S={...S,...q});const P=await tt("/api/profile",{method:"PUT",body:q,auth:!0});console.info("profile.update",P),rt("profile.update",P);try{if(c&&P&&P.lang_primary){c.value=P.lang_primary;try{await((R=window.SimpleI18n)==null?void 0:R.changeLanguage(P.lang_primary))}catch(V){}}if(Array.isArray(P==null?void 0:P.languages)){n=new Set(P.languages.filter(V=>V&&V!==(c==null?void 0:c.value)));try{window.selectedLanguages=n}catch(V){}l()}S={...S,...P},D(S)}catch(V){console.error("profile.update:sync failed",V),J("Profile update failed","error")}try{window.setNavbarTzBadge&&window.setNavbarTzBadge()}catch(V){}try{const V=document.getElementById("birthLocalLabel");if(V&&P&&P.birth_dt_utc&&(P.birth_tz||q.birth_tz)){const it=P.birth_tz||q.birth_tz,It=/Z$/i.test(String(P.birth_dt_utc))?String(P.birth_dt_utc):`${P.birth_dt_utc}Z`,zt=new Date(It),Nt=new Intl.DateTimeFormat("en-CA",{timeZone:it,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}),st=Object.fromEntries(Nt.formatToParts(zt).map(bt=>[bt.type,bt.value]));V.textContent=`${st.year}-${st.month}-${st.day} ${st.hour}:${st.minute} (${it})`}}catch(V){console.error("profile.update:render failed",V),J("Profile update failed","error")}const pt=v("currentUserId");pt&&j&&(pt.textContent=j);try{J("Profile updated successfully"),setTimeout(()=>{try{window.location.reload()}catch(V){}},80)}catch(V){}}catch(j){console.error("profile.update:ERROR",j);try{j&&j.status&&console.error("status",j.status)}catch(T){}try{j&&j.data&&console.error("data",j.data)}catch(T){}rt("profile.update:ERROR",j),J("Profile update failed","error")}})}),window.fetchAndRenderRadix=ut})();
