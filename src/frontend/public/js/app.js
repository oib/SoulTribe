(()=>{try{const t=localStorage.getItem("theme"),e=t||"dark";document.documentElement.setAttribute("data-theme",e)}catch(t){}const r=t=>document.getElementById(t),k=(t,e)=>{const n=r(t);return n&&(n.onclick=e),!!n},ut=r("out");let l=null,S=null,_=null,v=null;try{window.currentUserId=v}catch(t){}const P=t=>{try{const n=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(n).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(a)}catch(e){return null}},C=t=>String(t).padStart(2,"0"),Q=()=>{const t=new Date;return t.setMinutes(0,0,0),Date.now()>t.getTime()&&t.setHours(t.getHours()+1),t},F=(t,e)=>{t&&(t.value=`${e.getFullYear()}-${C(e.getMonth()+1)}-${C(e.getDate())}`)},j=t=>{if(!(!t||!t.options)&&!t.options.length)for(let e=0;e<24;e++){const n=document.createElement("option");n.value=String(e),n.textContent=`${C(e)}:00`,t.appendChild(n)}};function X(t,e){var n;try{const c=(((n=new Intl.DateTimeFormat("en-US",{timeZone:e,hour:"2-digit",minute:"2-digit",timeZoneName:"shortOffset"}).formatToParts(t).find(d=>d.type==="timeZoneName"))==null?void 0:n.value)||"").match(/([+-])(\d{1,2})(?::?(\d{2}))?/);if(!c)return 0;const s=c[1]==="-"?-1:1,u=parseInt(c[2]||"0",10),f=parseInt(c[3]||"0",10);return s*(u*60+f)}catch(a){return 0}}function tt(t,e,n){try{if(!t||e===""||e===null||e===void 0)return null;const[a,o,i]=String(t).split("-").map(m=>parseInt(m,10)),c=parseInt(e,10);if(!a||!o||!i||isNaN(c))return null;console.log(`Converting ${t} ${c}:00 from ${n} to UTC`);const s=`${t}T${c.toString().padStart(2,"0")}:00:00`,u=new Date(s),f=X(u,n);console.log(`Timezone offset for ${n} at ${s}: ${f} minutes`);const d=Date.UTC(a,o-1,i,c,0,0,0)-f*6e4,g=new Date(d).toISOString().replace(/\.\d{3}Z$/,"Z");return console.log(`Result: ${s} ${n} \u2192 ${g} UTC`),g}catch(a){return console.error("buildUtcIsoFromTz error:",a),null}}function B(t,e){try{if(!t||e===""||e===null||e===void 0)return null;const[n,a,o]=String(t).split("-").map(s=>parseInt(s,10)),i=parseInt(e,10);return!n||!a||!o||isNaN(i)?null:new Date(n,a-1,o,i,0,0,0).toISOString().replace(/\.\d{3}Z$/,"Z")}catch(n){return null}}const Z=()=>{const t=r("liveTz");if(!t)return;let e=[];try{Intl.supportedValuesOf&&(e=Intl.supportedValuesOf("timeZone"))}catch(o){}(!e||!e.length)&&(e=["Europe/Vienna","Europe/Berlin","Europe/Paris","Europe/London","America/New_York","America/Los_Angeles","America/Sao_Paulo","Asia/Tokyo","Asia/Singapore","Australia/Sydney","Africa/Johannesburg"]);const n=t.value;t.innerHTML="";const a=document.createElement("option");a.value="",a.textContent="Select timezone (city)",t.appendChild(a);for(const o of e){const i=document.createElement("option");i.value=o,i.textContent=o,t.appendChild(i)}n&&(t.value=n)};try{Z()}catch(t){}const et=()=>{const t=r("tzSearch"),e=r("liveTz");!t||!e||(t.addEventListener("input",()=>{const n=t.value.toLowerCase().replaceAll(" ","_");for(const a of e.options){if(!a.value){a.hidden=!1;continue}const o=String(a.textContent||"").toLowerCase(),i=String(a.value||"").toLowerCase();a.hidden=!(o.includes(n)||i.includes(n))}}),document.addEventListener("click",async n=>{const a=n.target;if(a instanceof HTMLElement&&a.classList.contains("btn-delete-slot"))try{a.disabled=!0;const o=parseInt(a.getAttribute("data-id")||"0",10);if(!o){a.disabled=!1;return}const i=await p(`/api/availability/${o}`,{method:"DELETE",auth:!0});h("availability.delete",i),w("Availability slot deleted");try{window.fetchAvailList&&await window.fetchAvailList()}catch(c){}try{window.fetchAndRenderMatches&&await window.fetchAndRenderMatches()}catch(c){}}catch(o){h("availability.delete:ERROR",o)}finally{try{a.disabled=!1}catch(o){}}}),document.addEventListener("click",async n=>{const a=n.target;if(a instanceof HTMLElement&&a.classList.contains("btn-unconfirm-meetup"))try{a.disabled=!0;const o=parseInt(a.getAttribute("data-id")||"0",10);if(!o){a.disabled=!1;return}const i=await p("/api/meetup/unconfirm",{method:"POST",auth:!0,body:{meetup_id:o}});h("meetup.unconfirm",i),w("Meetup unconfirmed");try{window.fetchAndRenderMeetups&&await window.fetchAndRenderMeetups()}catch(c){}}catch(o){h("meetup.unconfirm:ERROR",o)}finally{try{a.disabled=!1}catch(o){}}}))};try{et()}catch(t){}const W=()=>{const t=r("availStartDate").value,e=r("availStartHour").value,n=r("availEndDate").value,a=r("availEndHour").value,o=B(t,e),i=B(n,a);r("availUtcHint").textContent=o&&i?`Will save as UTC: ${o} \u2192 ${i}`:""};(function(){const e=r("availStartDate"),n=r("availStartHour"),a=r("availEndDate"),o=r("availEndHour");if(!e||!n||!a||!o)return;j(n),j(o);const i=Q(),c=new Date(i.getTime()+3600*1e3);F(e,i),F(a,c),n.value=String(i.getHours()),o.value=String(c.getHours()),[e,n,a,o].forEach(s=>{try{s.addEventListener("change",W)}catch(u){}}),W()})(),setTimeout(async()=>{if(l)try{const t=await p("/api/profile",{auth:!0});if(t&&typeof t.display_name!="undefined"){const e=r("displayName");e&&(e.value=t.display_name||"");const n=r("currentUserId");n&&t.display_name&&(n.textContent=t.display_name)}if(t&&t.live_tz){const e=r("liveTz");e&&(e.value=t.live_tz);const n=document.getElementById("liveTzLabel");n&&(n.textContent=t.live_tz)}else try{const e=r("liveTz"),n=Intl.DateTimeFormat().resolvedOptions().timeZone;if(n&&e&&!e.value){Z(),e.value=n,await p("/api/profile",{method:"PUT",body:{live_tz:n},auth:!0});const a=document.getElementById("liveTzLabel");a&&(a.textContent=n)}}catch(e){}if(t&&Array.isArray(t.languages)&&t.languages.length){const e=new Set(t.languages.map(a=>String(a)));document.querySelectorAll('.language-option input[type="checkbox"]').forEach(a=>{a.checked=e.has(a.value)}),typeof updateSelectedLanguages=="function"&&updateSelectedLanguages()}try{const e=r("birthDate"),n=r("birthTime"),a=r("birthPlace"),o=r("birthLat"),i=r("birthLon"),c=r("birthTz");if(e&&t.birth_dt_utc){const s=new Date(t.birth_dt_utc),u=s.getUTCFullYear(),f=String(s.getUTCMonth()+1).padStart(2,"0"),d=String(s.getUTCDate()).padStart(2,"0");if(e.value=`${u}-${f}-${d}`,n&&t.birth_time_known){const g=String(s.getUTCHours()).padStart(2,"0"),m=String(s.getUTCMinutes()).padStart(2,"0");n.value=`${g}:${m}`}}a&&t.birth_place_name&&(a.value=t.birth_place_name),o&&typeof t.birth_lat=="number"&&(o.value=String(t.birth_lat)),i&&typeof t.birth_lon=="number"&&(i.value=String(t.birth_lon)),c&&t.birth_tz&&(c.value=t.birth_tz)}catch(e){}}catch(t){}},200),k("btn-avail-create",async()=>{try{let b=function(y){return String(y).padStart(2,"0")},A=function(y,R,x,O){return`${y}-${b(R)}-${b(x)}T${b(O)}:00:00`},K=function(y,R,x,O){const T=new Date(Date.UTC(y,R-1,x,12,0,0));return T.setUTCDate(T.getUTCDate()+O),{y:T.getUTCFullYear(),m:T.getUTCMonth()+1,d:T.getUTCDate()}};var t=b,e=A,n=K;let a=typeof window!="undefined"&&window.liveTz?window.liveTz:null;if(!a)try{a=localStorage.getItem("live_tz")}catch(y){}if(!a)try{a=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(y){}a||(a="UTC");const o=tt(r("availStartDate").value,r("availStartHour").value,a),i=parseInt(r("availDurationHours").value||"1",10);if(!o||isNaN(i))throw new Error("Please pick valid start and duration");const c=new Date(o),s=new Date(c.getTime()+i*3600*1e3).toISOString().replace(/\.\d{3}Z$/,"Z");if(!o||!s)throw new Error("Please pick valid start and end datetimes");if(new Date(s)<=new Date(o))throw new Error("End must be after start");const u=r("availStartDate").value,f=parseInt(r("availStartHour").value,10),[d,g,m]=u.split("-").map(Number),ct=A(d,g,m,f);let U=f+i,H=d,M=g,N=m;for(;U>=24;)U-=24,{y:H,m:M,d:N}=K(H,M,N,1);const st=A(H,M,N,U),lt=await p("/api/availability",{method:"POST",body:{start_dt_utc:o,end_dt_utc:s,start_dt_local:ct,end_dt_local:st,timezone:a},auth:!0});h("availability.create",lt);try{window.fetchAvailList&&await window.fetchAvailList()}catch(y){}try{window.fetchAndRenderMatches&&await window.fetchAndRenderMatches()}catch(y){}w("Availability slot created")}catch(a){h("availability.create:ERROR",a);try{w(q(a,"Failed to create availability"),"error")}catch(o){}}}),k("btn-avail-delete",async()=>{var t;try{const e=parseInt(r("availDeleteId").value,10),n=await p(`/api/availability/${e}`,{method:"DELETE",auth:!0});h("availability.delete",n);try{await((t=document.getElementById("btn-avail-list"))==null?void 0:t.click())}catch(a){}}catch(e){h("availability.delete:ERROR",e)}});const p=async(t,e={})=>{const{method:n="GET",body:a,auth:o=!1,returnResponse:i=!1,_retrying:c=!1}=e,s={"Content-Type":"application/json"};o&&l&&(s.Authorization=`Bearer ${l}`);const u=await fetch(t,{method:n,headers:s,body:a?JSON.stringify(a):void 0}),f=await u.text();let d;try{d=JSON.parse(f)}catch(m){d=f}if(!u.ok){if(o&&u.status===401&&!c&&S)try{await V();const b={...e,_retrying:!0};return p(t,b)}catch(b){}throw{status:u.status,data:d,response:u}}const g=i?{data:d,response:u}:d;try{o&&t==="/api/profile"&&!i&&g&&typeof g=="object"&&(window.profileMeta={email_verified:!!g.email_verified})}catch(m){}return g},h=(t,e)=>{const n=document.getElementById("out");if(!n)return;const o=`[${new Date().toISOString()}] ${t}:
`+JSON.stringify(e,null,2)+`

`;n.textContent=o+n.textContent};window.fetchAndRenderMatches=null;const J=()=>{const t=r("tokenPreview");t&&(t.textContent=l?l.slice(0,32)+"\u2026":"(none)");const e=l?P(l):null;v=e&&e.sub?parseInt(e.sub,10):null;try{window.currentUserId=v}catch(o){}const n=r("currentUserId");n&&(n.textContent=v!=null?v:"(unknown)");const a=r("findUserId");v&&a&&!a.value&&(a.value=String(v))},nt=()=>{};let D=0;const w=(...t)=>{if(!(D>2)){D++;try{const e=typeof window!="undefined"?window.toast:null;return typeof e=="function"&&e!==w?e(...t):nt(...t)}finally{D--}}},q=(t,e)=>{if(typeof window.errorMessage=="function")return window.errorMessage(t,e);try{return t&&t.data&&t.data.detail?t.data.detail:(t==null?void 0:t.message)||e||"Error"}catch(n){return e||"Error"}},I=t=>{l=t||null;try{window.token=l}catch(e){}if(l)try{localStorage.setItem("access_token",l)}catch(e){}else try{localStorage.removeItem("access_token")}catch(e){}J()},E=t=>{S=t||null;try{window.refreshToken=S}catch(e){}if(S)try{localStorage.setItem("refresh_token",S)}catch(e){}else try{localStorage.removeItem("refresh_token")}catch(e){}},V=async()=>{if(!S)throw{status:401,detail:"No refresh token available"};return _||(_=(async()=>{const t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:S})}),e=await t.text();let n;try{n=JSON.parse(e)}catch(a){n=e}if(!t.ok)throw I(null),E(null),{status:t.status,data:n,response:t};return n&&typeof n=="object"&&(n.access_token&&I(n.access_token),n.refresh_token&&E(n.refresh_token)),n})().finally(()=>{_=null})),_};function L(){const t=!!l,e=r("btn-profile-link"),n=r("btn-login-link"),a=r("btn-logout");e&&(e.style.display=t?"inline-flex":"none"),n&&(n.style.display=t?"none":"inline-flex"),a&&(a.style.display=t?"inline-flex":"none")}document.addEventListener("DOMContentLoaded",()=>{try{(()=>{if(typeof window.toast!="function"&&!document.getElementById("toast-js")){const e=document.createElement("script");e.src="/js/toast.js",e.id="toast-js",document.head.appendChild(e)}})()}catch(t){}L(),ot();try{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(t=>{try{window.__swReg=t}catch(e){}}).catch(()=>{})}catch(t){}});async function Y(){try{return"Notification"in window?Notification.permission==="granted"?!0:Notification.permission==="denied"?!1:await Notification.requestPermission()==="granted":!1}catch(t){return!1}}async function at(t,e,n={},a){try{if(!await Y())return!1;if((window.__swReg||navigator.serviceWorker&&await navigator.serviceWorker.getRegistration())&&navigator.serviceWorker&&navigator.serviceWorker.controller)return navigator.serviceWorker.controller.postMessage({type:"notify",title:t,body:e,data:n,tag:a}),!0;try{new Notification(t,{body:e})}catch(c){}return!0}catch(o){return!1}}try{window.ensureNotificationPermission=Y}catch(t){}try{window.notifyViaSW=at}catch(t){}let $=!1;async function z(t){if(!t||!window.SimpleI18n)return;const e=await window.SimpleI18n.detectSupportedLanguages(),n=window.SimpleI18n.currentLang||"en",a=Object.entries(window.SimpleI18n.languages||{}).filter(([o])=>e.includes(o));if(a.length===0){t.innerHTML='<option value="en" selected>EN - English</option>';return}a.sort((o,i)=>o[1].localeCompare(i[1])),t.innerHTML=a.map(([o,i])=>{const c=`${o.toUpperCase()} - ${i}`;return`<option value="${o}" ${o===n?"selected":""}>${c}</option>`}).join("")}async function ot(){const t=document.getElementById("language-selector");if(t)try{await z(t),t.addEventListener("change",async e=>{var o;if($)return;const n=e.target.value,a=(o=window.SimpleI18n)==null?void 0:o.currentLang;if(!(!n||n===a)){$=!0,t.disabled=!0;try{if(!await window.SimpleI18n.changeLanguage(n))t.value=a||"en",w(`Failed to load ${n} translations. Using ${a||"English"} instead.`,"error");else{await z(t);const c=window.SimpleI18n.languages[n]||n;w(`Language changed to ${c}`,"success")}}catch(i){console.error("Error changing language:",i),t.value=a||"en",w("An error occurred while changing the language.","error")}finally{t.disabled=!1,$=!1}}}),window.addEventListener("languageChanged",async e=>{var n;(n=e.detail)!=null&&n.language&&t.value!==e.detail.language&&(t.value=e.detail.language,await z(t))})}catch(e){console.error("Error initializing language selector:",e),t.innerHTML='<option value="en" selected>EN - English</option>'}}document.addEventListener("DOMContentLoaded",async()=>{try{if(!window.liveTz&&typeof l!="undefined"&&l){const t=await p("/api/profile",{auth:!0});if(t&&t.live_tz){window.liveTz=t.live_tz;try{localStorage.setItem("live_tz",t.live_tz)}catch(e){}}else try{const e=localStorage.getItem("live_tz");e&&(window.liveTz=e)}catch(e){}try{const e=t&&t.lang_primary?String(t.lang_primary):null,n=typeof window.SimpleI18n!="undefined";if(e){let a=null;try{a=localStorage.getItem("selectedLanguage")}catch(o){}try{localStorage.setItem("selectedLanguage",e)}catch(o){}if(n&&window.SimpleI18n.languages&&window.SimpleI18n.languages[e])try{await window.SimpleI18n.changeLanguage(e)}catch(o){}else try{document.documentElement.setAttribute("lang",e)}catch(o){}try{if(e&&a!==e&&typeof window.toast=="function"){const o=window.SimpleI18n,i=o&&o.languages&&o.languages[e]?o.languages[e]:e,c=o&&typeof o.t=="function"?o.t("notifications.language_set_to"):"Language set to";window.toast(`${c} ${i}`)}}catch(o){}}}catch(e){}}it();try{G()}catch(t){}try{rt()}catch(t){}try{const t=document.getElementById("btn-logout");t&&(t.onclick=()=>{try{I(null)}catch(e){}try{localStorage.removeItem("access_token")}catch(e){}try{L()}catch(e){}try{window.location.href="/login.html"}catch(e){}})}catch(t){}}catch(t){}});function it(){const t=document.getElementById("availTzHint");if(!t)return;let e=window.liveTz;if(!e)try{e=localStorage.getItem("live_tz")}catch(n){}if(!e)try{e=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(n){}e||(e="UTC"),t.textContent=`Using timezone: ${e}`}function G(){try{const t=window.SimpleI18n,e=t&&t.languages?t.languages:null;if(!e)return;document.querySelectorAll(".badge").forEach(a=>{try{const o=(a.textContent||"").trim();if(/^[A-Za-z]{2}$/.test(o)){const i=o.toLowerCase();e[i]&&(a.textContent=e[i])}}catch(o){}})}catch(t){}}try{window.addEventListener("languageChanged",()=>{try{G()}catch(t){}})}catch(t){}function rt(){try{if(document.querySelector('[data-component="footer"]')||document.querySelector(".site-footer")||document.getElementById("siteFooter"))return;const t=document.createElement("footer");t.id="siteFooter",t.className="site-footer",t.innerHTML=`
        <div class="site-footer-inner">
          <a href="/terms.html" data-i18n="footer.terms">Terms</a>
          <span class="sep">|</span>
          <a href="/privacy.html" data-i18n="footer.privacy">Privacy</a>
          <span class="sep">|</span>
          <a href="/imprint.html" data-i18n="footer.imprint">Imprint</a>
        </div>
      `,document.body.appendChild(t);try{window.SimpleI18n&&typeof window.SimpleI18n.updateUI=="function"&&window.SimpleI18n.updateUI()}catch(e){}}catch(t){}}document.addEventListener("DOMContentLoaded",()=>{try{const t=r("availStartDate"),e=r("availStartHour"),n=null,a=r("availDurationHours");if(t){const o=new Date,i=o.getFullYear(),c=String(o.getMonth()+1).padStart(2,"0"),s=String(o.getDate()).padStart(2,"0");t.value=`${i}-${c}-${s}`}if(e&&a){const i=new Date().getHours();e.value=String(i),a.value="1"}}catch(t){}});try{const t=localStorage.getItem("refresh_token");t&&E(t)}catch(t){}try{const t=localStorage.getItem("access_token");t&&(I(t),L())}catch(t){}try{typeof window.token=="undefined"&&(window.token=l)}catch(t){}J(),window.api=p,window.show=h;try{typeof window.toast!="function"&&(window.toast=w)}catch(t){}try{typeof window.errorMessage!="function"&&(window.errorMessage=q)}catch(t){}window.bindClick=k,window.parseJwt=P,window.setToken=I,window.updateAuthUI=L,window.setRefreshToken=E,window.refreshAccessToken=V,window.fetchAndRenderRadix=null})();
