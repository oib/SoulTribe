(()=>{const r=u=>document.getElementById(u),h=window.api,d=window.show,c=(...u)=>{try{const n=typeof window!="undefined"?window.toast:null;if(typeof n=="function")return n(...u)}catch(n){}},g=window.bindClick,S=window.parseJwt,w=window.setToken,p=window.setRefreshToken,_=window.updateAuthUI;document.addEventListener("DOMContentLoaded",()=>{g("btn-register",async()=>{var n,a,t,o,i;try{const e=(n=r("email"))==null?void 0:n.value.trim(),s=(a=r("password"))==null?void 0:a.value,l=(t=r("passwordConfirm"))==null?void 0:t.value;if(typeof l=="string"&&l.length&&s!==l){try{c(SimpleI18n.t("login.password_mismatch"),"error")}catch(v){}return}const m=(i=(o=r("displayName"))==null?void 0:o.value)==null?void 0:i.trim(),f=m&&m.length?m:e&&e.includes("@")?e.split("@")[0]:"Friend";if(!e||!s||!f)return c(SimpleI18n.t("login.required_fields"),"error");try{console.debug("register:payload",{email:e,display_name:f})}catch(v){}const y=await h("/api/auth/register",{method:"POST",body:{email:e,password:s,display_name:f}});w(y.access_token),y.refresh_token&&p(y.refresh_token);try{c(SimpleI18n.t("login.registration_success"),"success")}catch(v){}setTimeout(()=>{try{window.location.href="/profile.html"}catch(v){}},700)}catch(e){d("register:ERROR",e);try{const s=e&&e.data&&e.data.detail?e.data.detail:null;if(s){console.error("register:ERROR.detail",s);const l=Array.isArray(s)&&s.length?s[0]:null,m=l&&l.msg?l.msg:typeof s=="string"?s:"Registration failed";c(m,"error")}}catch(s){}}}),g("btn-reset-request",async()=>{var n;try{const a=(n=r("email"))==null?void 0:n.value.trim();if(!a)return c(SimpleI18n.t("login.enter_email_first"),"error");const t=await h("/api/auth/reset-request",{method:"POST",body:{email:a}});d("reset-request",t),c(SimpleI18n.t("login.reset_sent"),"success")}catch(a){d("reset-request:ERROR",a),c(SimpleI18n.t("login.reset_sent"),"success")}}),g("btn-resend-verification",async n=>{var a;n.preventDefault();try{const t=(a=r("email"))==null?void 0:a.value.trim();if(!t)return c(SimpleI18n.t("login.enter_email_first"),"error");const o=await h("/api/auth/resend-verification",{method:"POST",body:{email:t}});d("resend-verification",o),c(SimpleI18n.t("login.verification_sent"),"success")}catch(t){d("resend-verification:ERROR",t),c(SimpleI18n.t("login.verification_sent"),"success")}}),g("btn-login",async()=>{var n,a,t,o;try{const i=(n=r("email"))==null?void 0:n.value.trim(),e=(a=r("password"))==null?void 0:a.value;if(!i||!e)return c(SimpleI18n.t("login.login_required"),"error");const s=await h("/api/auth/login",{method:"POST",body:{email:i,password:e}});s.access_token&&(w(s.access_token),s.refresh_token&&p(s.refresh_token),_(),window.location.href="/dashboard.html")}catch(i){d("login:ERROR",i);try{const e=i&&i.data&&i.data.detail?i.data.detail:null;let s=e?typeof e=="string"?e:((t=e[0])==null?void 0:t.msg)||"Login failed":i.status===401?"Invalid credentials":"Login failed";if(i.status===401&&e==="Email not verified"){const l=(o=r("email"))==null?void 0:o.value.trim();if(l){const m=document.getElementById("resend-verification-container");if(m){m.classList.remove("hidden");const f=document.getElementById("btn-resend-verification");f&&(f.dataset.email=l)}}}c(s,"error")}catch(e){}}}),g("btn-logout",()=>{w(null),p(null);try{localStorage.removeItem("access_token")}catch(n){}try{localStorage.removeItem("refresh_token")}catch(n){}_(),window.location.href="/login.html"});const u=document.getElementById("authForm");u&&u.addEventListener("submit",async n=>{var a;n.preventDefault();try{const t=r("email").value.trim(),o=r("password").value,i=await h("/api/auth/login",{method:"POST",body:{email:t,password:o}});w(i.access_token),i.refresh_token&&p(i.refresh_token),d("login",i),r("password").value="";try{history.replaceState(null,"",window.location.pathname)}catch(e){}try{const e=String(window.location.pathname||"");(e.endsWith("/login.html")||e==="/login")&&(window.location.href="/dashboard.html")}catch(e){}}catch(t){d("login:ERROR",t);try{const o=t&&t.data&&t.data.detail?t.data.detail:null,i=o?typeof o=="string"?o:((a=o[0])==null?void 0:a.msg)||"Login failed":t.status===401?"Invalid credentials":"Login failed";c(i,"error")}catch(o){}}});try{const n=new URLSearchParams(window.location.search),a=n.get("email"),t=n.get("password");if(a&&(r("email").value=a),t&&(r("password").value=t),a&&t){const o=document.getElementById("authForm");o&&setTimeout(()=>{o.requestSubmit?o.requestSubmit():r("btn-login").click();try{history.replaceState(null,"",window.location.pathname)}catch(i){}},100)}}catch(n){}})})();
