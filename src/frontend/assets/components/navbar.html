<!-- Navigation will be loaded here by components.js -->
<nav class="navbar">
  <div class="navbar-container">
    <!-- Brand/logo (centered) -->
    <a href="/" aria-label="SoulTribe.chat home">
      <div class="navbar-logo-container">
        <div class="navbar-logo">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 100" width="400" height="100">
            <defs>
              <linearGradient id="cosmicGradient" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#7f5af0"/>
                <stop offset="50%" stop-color="#5a4fcf"/>
                <stop offset="100%" stop-color="#f3d08a"/>
              </linearGradient>
              <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="2.5" result="blur"/>
                <feMerge>
                  <feMergeNode in="blur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
                  font-family="Segoe UI, sans-serif" font-size="42" font-weight="700"
                  fill="url(#cosmicGradient)" filter="url(#glow)">
              SoulTribe.chat
            </text>
          </svg>
        </div>
      </div>
    </a>

    <button class="navbar-toggle" aria-label="Toggle navigation" type="button" aria-expanded="false" aria-controls="navbar-menu">
      <span class="hamburger"></span>
      <span class="hamburger"></span>
      <span class="hamburger"></span>
    </button>

    <div class="navbar-menu" id="navbar-menu">
      <button class="navbar-menu-close" type="button" aria-label="Close menu">
        <span></span>
        <span></span>
      </button>
      <div class="navbar-left">
        <div class="language-selector-container">
          <select id="language-selector" class="language-selector" aria-label="Select language">
            <option value="de">Deutsch</option>
            <option value="en" selected>English</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
            <option value="it">Italiano</option>
            <option value="pt">Português</option>
          </select>
        </div>
        <span class="badge mono" id="tzTopBadgeText" style="margin-left:8px; display:none;">Using timezone: …</span>
      </div>

      <div class="navbar-right">
        <div class="user-menu" style="display: flex; align-items: center; gap: 10px;">
          <a href="/login.html" id="login-link" class="btn btn-primary" style="display: inline-block;" data-i18n="landing.next.login_register">Login / Register</a>
          <a href="/profile.html" id="profile-btn" class="btn btn-primary" style="display: none;" data-i18n="nav.profile">Profile</a>
          <a href="/dashboard.html" id="dashboard-btn" class="btn btn-primary" style="display: none;" data-i18n="nav.dashboard">Dashboard</a>
          <button id="logout-btn" class="btn btn-secondary" data-i18n="nav.logout" style="display: none;">Log Out</button>
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  // Namespaced navbar UI update to avoid colliding with page-level functions
  function computeNavbarBadgeVisibility() {
    const isAuthenticated = !!localStorage.getItem('access_token');
    const onProfile = location.pathname.endsWith('/profile.html');
    const onDashboard = location.pathname.endsWith('/dashboard.html');
    const onLanding = document.body.classList.contains('welcome-page') || location.pathname === '/' || location.pathname.endsWith('/index.html');
    const onGuestGuide = location.pathname.endsWith('/docs/guest-jitsi-guide.html');
    return isAuthenticated && (onProfile || onDashboard) && !onLanding && !onGuestGuide;
  }

  function updateNavbarAuthUI() {
    const isAuthenticated = !!localStorage.getItem('access_token');

    // Toggle right-corner buttons
    const loginLink = document.getElementById('login-link');
    const profileBtn = document.getElementById('profile-btn');
    const dashboardBtn = document.getElementById('dashboard-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const onProfile = location.pathname.endsWith('/profile.html');
    const onDashboard = location.pathname.endsWith('/dashboard.html');
    const onLogin = location.pathname.endsWith('/login.html');

    if (loginLink) loginLink.style.display = (!isAuthenticated && !onLogin) ? 'inline-block' : 'none';
    // Show Profile everywhere except on profile page (there show Dashboard instead)
    if (profileBtn) profileBtn.style.display = isAuthenticated && !onProfile ? 'inline-block' : 'none';
    if (dashboardBtn) dashboardBtn.style.display = isAuthenticated && onProfile ? 'inline-block' : 'none';
    if (logoutBtn) logoutBtn.style.display = isAuthenticated ? 'inline-block' : 'none';

    document.body.classList.toggle('authenticated', isAuthenticated);
    document.body.classList.toggle('guest', !isAuthenticated);

    // Toggle timezone badge visibility: only on profile/dashboard, when authenticated
    try {
      const tzBadge = document.getElementById('tzTopBadgeText');
      const shouldShow = computeNavbarBadgeVisibility();
      if (tzBadge) {
        tzBadge.style.display = shouldShow ? 'inline-block' : 'none';
      }
    } catch {}
  }

  // Expose only the navbar-specific updater
  window.updateNavbarAuthUI = updateNavbarAuthUI;

  // Initialize language selector and auth state after full page load to avoid pre-style layout thrash
  function initNavbar() {
    try {
      const langSelector = document.getElementById('language-selector');
      const langWrap = document.querySelector('.language-selector-container');
      const isLandingPage = () => (
        document.body.classList.contains('welcome-page') ||
        location.pathname === '/' ||
        location.pathname.endsWith('/index.html')
      );

      // Helper: enforce landing-only visibility (call on init and on language changes)
      function enforceLangSelectorVisibility() {
        const onLanding = isLandingPage();
        if (langWrap) langWrap.style.display = onLanding ? 'flex' : 'none';
      }
      // Apply initial state
      enforceLangSelectorVisibility();
      if (langSelector && isLandingPage()) {
        const savedLang = localStorage.getItem('i18nextLng') || 'en';
        if (savedLang && langSelector.querySelector(`option[value="${savedLang}"]`)) {
          langSelector.value = savedLang;
        }
        langSelector.addEventListener('change', function(e) {
          const lang = e.target.value;
          localStorage.setItem('i18nextLng', lang);
          if (window.SimpleI18n && typeof SimpleI18n.changeLanguage === 'function') {
            SimpleI18n.changeLanguage(lang);
          } else if (window.i18next && typeof i18next.changeLanguage === 'function') {
            i18next.changeLanguage(lang);
          }
        });
      }
      // Re-enforce visibility whenever the app language changes
      try { window.addEventListener('languageChanged', enforceLangSelectorVisibility); } catch {}

      // Listen to storage changes for auth token from other tabs
      window.addEventListener('storage', function(e) {
        if (e.key === 'access_token') updateNavbarAuthUI();
        if (e.key === 'live_tz') setNavbarTzBadge();
      });

      // Wire logout button (sync with app.js setToken logic)
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          try { if (typeof window.setToken === 'function') window.setToken(null); } catch {}
          try { window.token = null; } catch {}
          try { localStorage.removeItem('access_token'); } catch {}
          try { localStorage.removeItem('user'); } catch {}
          updateNavbarAuthUI();
          // Prefer sending user to login page after logout
          try { window.location.href = '/login.html'; } catch { window.location.href = '/'; }
        });
      }

      // Initial state
      updateNavbarAuthUI();
      setNavbarTzBadge();
    } catch (err) {
      console.warn('Navbar init error:', err);
    }
  }

  if (document.readyState === 'complete') {
    initNavbar();
  } else {
    window.addEventListener('load', initNavbar, { once: true });
  }

  // --- Timezone badge computation (navbar scope) ---
  function setNavbarTzBadge() {
    try {
      const el = document.getElementById('tzTopBadgeText');
      if (!el) return;
      // Only show for authenticated users; text can still be set regardless
      const tz = (function resolveLiveTz(){
        let z = null;
        try { z = window.liveTz || null; } catch {}
        if (!z) { try { z = localStorage.getItem('live_tz'); } catch {} }
        if (!z) { try { z = Intl.DateTimeFormat().resolvedOptions().timeZone; } catch {} }
        return z || 'UTC';
      })();
      const off = (function tzOffsetLabel(tzId){
        try {
          const fmt = new Intl.DateTimeFormat('en-US', { timeZone: tzId, hour:'2-digit', minute:'2-digit', timeZoneName:'shortOffset' });
          const parts = fmt.formatToParts(new Date());
          const tzName = parts.find(p=>p.type==='timeZoneName')?.value || '';
          const m = tzName.match(/([+-])(\d{1,2})(?::?(\d{2}))?/);
          if (!m) return '';
          const sign = m[1] === '-' ? '-' : '+';
          const hh = String(parseInt(m[2]||'0',10)).padStart(2,'0');
          const mm = String(parseInt(m[3]||'0',10)).padStart(2,'0');
          return `UTC${sign}${hh}:${mm}`;
        } catch { return ''; }
      })(tz);
      el.textContent = `${tz}${off ? ` (${off})` : ''}`;
    } catch {}
  }

  // Make timezone badge updater accessible globally for other scripts (e.g., profile.js)
  try { window.setNavbarTzBadge = setNavbarTzBadge; } catch {}
  try { window.refreshNavbarProfile = undefined; } catch {}
</script>
