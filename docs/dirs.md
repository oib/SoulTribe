# Directory Cleanup & Migration Plan

_Last updated: 2025-09-24_

> **Plan B — incremental moves.** We will relocate files only when they are actively modified, migrating and verifying them one-by-one instead of executing a sweeping batch move. The phased plan below still applies as a target end-state, but progress will accrue opportunistically with each touched file.

## Goals
- Reduce clutter in the project root by relocating implementation code into `src/`.
- Separate build inputs (source files) from outputs (served/static artifacts).
- Prepare for future tooling (bundlers, type checkers, tests) without disrupting the current FastAPI + static deployment flow.
- Document the required rewiring so the transition can be executed incrementally without downtime.

## Target Top-Level Layout

| Path | Purpose |
| --- | --- |
| `src/backend/` | All FastAPI app code, models, services, and background scripts. Mirrors current Python modules. |
| `src/frontend/` | All frontend source material: modular JS, components, styles, images, localization JSON. |
| `src/frontend/public/` | Files to be served statically without processing (favicons, manifest, robots, etc.). |
| `src/frontend/scripts/` | Script entry points (`app.js`, `dashboard.js`, `profile.js`, admin panels, service worker sources). |
| `src/frontend/styles/` | CSS sources, theme files, per-page styles. |
| `src/frontend/templates/` | HTML templates/pages (`index.html`, `dashboard.html`, admin screens). |
| `src/frontend/i18n/` | Translation JSON files and helpers (currently under `web/i18n`). |
| `web/` | Build output / publish directory. Initially identical to current tree; after migration, generated by build step. |
| `docs/` | Product and engineering documentation (unchanged). |

## Phase 0 — Prep (current sprint)
- Confirm no runtime code reads from `web/` at import time (only FastAPI static mount). ✅
- Introduce `src/` with empty `backend/` and `frontend/` directories (already present).
- Capture this migration plan in `docs/dirs.md` (this file). ✅

## Phase 1 — Frontend Source Relocation
1. **Move JS/CSS/HTML into `src/frontend/`**
   - Relocate each existing file from `web/` to its category (`scripts/`, `styles/`, `templates/`).
   - Keep relative paths between HTML ↔ assets for now; adjust `<script>`/`<link>` URLs to point to future build output structure.
2. **Split Shared Assets**
   - Place shared components (currently in `web/components/` and `web/js/`) under `src/frontend/scripts/components/`.
   - Consolidate CSS partials (e.g., `theme.css`, `styles.css`) into `styles/`.
3. **Preserve Static Assets**
   - Copy non-processed files (favicon, sitemap, robots, sellers.json, etc.) into `public/`.
4. **Introduce Build Step (temporary)**
   - Add a simple `make build-frontend` task that copies `src/frontend/public/` → `web/` and bundles/minifies JS/CSS using an interim tool (e.g., `esbuild` or `vite`).
   - Ensure the build outputs keep the same filenames as today so FastAPI routing remains unchanged.

## Phase 2 — Backend Relocation
1. **Move Python packages into `src/backend/`**
   - Update imports to use namespace packages (e.g., `from src.backend.routes import ...`).
   - Adjust `PYTHONPATH` in `make dev`, Gunicorn config, and tests to include `src/backend`.
2. **Relocate scripts**
   - Move `dev/` scripts that are pure Python into `src/backend/scripts/` while keeping systemd unit files under `dev/`.

## Phase 3 — Configuration Rewire
- Update `main.py` (or its successor) to mount static files from `web/` (build output) and to load backend modules from `src/backend`.
- Update CI/CD to run `make build-frontend` before packaging/deployment.
- Adjust Dockerfiles or deployment scripts to copy `web/` after the build step instead of the legacy `web/` sources.
- Ensure Alembic still discovers migrations (may require `PYTHONPATH` or `script_location` tweaks).

## Phase 4 — Cleanup & Validation
- Remove leftover files from the root `web/` directory once the build outputs are generated deterministically.
- Add lint/test coverage specific to the new layout (e.g., `npm run lint`, `pytest`).
- Document developer workflow changes in `README.md` and `docs/CurrentState.md`.
- Sunset redundant directories (e.g., `web/js`, `web/components`) after verifying references.

## Open Questions / Decisions Needed
- Choose a frontend build tool: `esbuild`, `Vite`, or keep plain copy for now.
- Determine if legacy admin tools should remain as vanilla JS or migrate to a framework (React/Svelte) while moving to `src/frontend/`.
- Decide on bundling strategy for service worker (`sw.js`) and shared helper modules.
- Evaluate whether translation JSONs remain raw or gain an AI-assisted generation pipeline.

## Next Steps Checklist
- **Owner**: _TBD_
- **Approve plan** ➡️ move to Phase 1 execution.
- **Set up tracking** (issue/tickets) for each phase to avoid multi-week drift.

## Appendix — Current Web Directory Snapshot
```
web/
├── admin/
├── admin-i18n.html
├── admin-i18n.js
├── app.js
├── components/
├── css/
├── dashboard.css
├── dashboard.html
├── dashboard.js
├── favicon.ico
├── favicon.svg
├── i18n/
├── img/
├── index.html
├── login.html
├── login.js
├── profile.html
├── profile.js
├── scripts/
├── styles.css
├── sw.js
└── ... (additional static assets)
```

This snapshot will be replaced with generated artifacts once Phase 1 completes.
